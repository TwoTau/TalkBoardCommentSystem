<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Talkboard</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://rawgit.com/TwoTau/TalkboardAssets/master/lecture-stylesheet.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default navbar-static-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Talkboard</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <!-- <li class="active"><a href="#">Home <span class="sr-only">(current)</span></a></li> -->
        <li><a href="#">Dashboard</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Log out  <i class="fa fa-user" aria-hidden=true></i></a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<div class="row">
    <div class="col-lg-8 col-md-8 col-sm-12">
        <div class="container lecture">
            <h2>Lecture name</h2>
            <div style="background-color: lightgrey; height: 480px; width: 640px; margin-top: 20px;"></div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 col-sm-12 pull-right chat">
        <div class="discussions">
        <h2>Discussions</h2>
        </div>
        <div class="chat-area">
          <div class="bubbles pre-scrollable">

          </div>
          <textarea id="messageInput" class="well" placeholder="Send a message to your class..." style="position: absolute; bottom: 0; height: 15%; width: 93%; border: 1px solid #DADFE1; margin: 0"></textarea>
        </div>
    </div>

    <script>
        var username = "{{ token }}";

        var messageCount = 0;
        var messageText = "";

        function sendMessage(message) {
            $.ajax({
                method: "POST",
                url: "send",
                data: {
                    "username": username,
                    "message": message
                }
            }).done(function() {
                console.log(message + " sent.");
            });
        }

        $(function() {
            var loadChat = function() {
                $.ajax({
                    url: "messages",
                    cache: false
                }).done(function(html) {
                    var newMessagesCount = parseInt(html.substr(9,3));

                    allDivs = html.split("<div data-username=");
                    allDivs.shift(0);

                    for(var i = messageCount; i < newMessagesCount; i++) {
                        var newCommentText = "<div data-username=" + allDivs[i];
                        var newComment = $(newCommentText);
                        newComment.addClass("bubble");
                        if(newComment.data(username) === username) {
                            newComment.addClass("me");
                        } else {
                            newComment.addClass("you");
                        }

                        $(".bubbles.pre-scrollable").append(newComment);
                    }

                    if(newMessagesCount > messageCount) messageCount = newMessagesCount;
                    messageText = html;
                });
            };

            $("#messageInput").keypress(function(e) {
                if(e.which == 13) {
                    e.preventDefault();

                    var message = $("#messageInput").val();
                    sendMessage(message);
                    $("#messageInput").val("");
                }
            });

            loadChat();
            window.setInterval(loadChat, 100); // checks ~ 3 times a second
        });
    </script>
</div>

</body>
